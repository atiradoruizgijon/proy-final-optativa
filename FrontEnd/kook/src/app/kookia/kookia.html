<main class="container-fluid d-flex flex-column h-100">
    <!-- Header -->
    <div class="chat-header bg-primary text-white p-3">
        <h2 class="mb-0">
            KookIA - Tu Asistente de Cocina
        </h2>
        <small>Pregúntame por recetas, técnicas de cocina y mucho más</small>
    </div>

    <!-- contenedor de los mensajes -->
    <div class="chat-messages flex-grow-1 overflow-auto p-3" style="height: 60vh;">
        <!-- Mensajes -->
        <div *ngFor="let message of messages; let i = index" class="mb-3">
            <!-- mensaje del usuario -->
            <div *ngIf="message.type === 'user'" class="d-flex justify-content-end">
                <div class="bg-primary text-white rounded-3 p-3" style="max-width: 70%;">
                    <p class="mb-0">{{ message.content }}</p>
                    <small class="text-white-50">{{ message.timestamp | date:'short' }}</small>
                </div>
            </div>

            <!-- mensaje del bot -->
            <div *ngIf="message.type === 'bot'" class="d-flex justify-content-start">
                <div class="bg-light rounded-3 p-3" style="max-width: 70%;">
                    <p class="mb-0" style="white-space: pre-wrap;">{{ message.content }}</p>
                    <small class="text-muted">{{ message.timestamp | date:'short' }}</small>

                    <!-- botón para guardar receta si contiene instrucciones -->
                    <div class="mt-2" *ngIf="i > 0 && (message.content.toLowerCase().includes('ingredientes') || message.content.toLowerCase().includes('instrucciones'))">
                        <button (click)="prepareRecipeForSave(i)" class="btn btn-sm btn-success">
                            Guardar como receta
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- indicador de carga -->
        <div *ngIf="isLoading" class="d-flex justify-content-start">
            <div class="bg-light rounded-3 p-3">
                <p class="mb-0">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    KookIA está escribiendo...
                </p>
            </div>
        </div>
    </div>

    <!-- mensajes de estado -->
    <div class="px-3" *ngIf="errorMsg">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ errorMsg }}
        </div>
    </div>

    <div class="px-3" *ngIf="successMsg">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ successMsg }}
        </div>
    </div>

    <!-- guardar receta -->
    <div *ngIf="showSaveRecipeForm" class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Guardar receta desde KookIA</h5>
                    <button type="button" class="btn-close" (click)="cancelSaveRecipe()"></button>
                </div>
                <div class="modal-body">
                    <form [formGroup]="formReceta">
                        <div class="mb-3">
                            <label for="titulo" class="form-label">Título de la receta</label>
                            <input
                                type="text"
                                class="form-control"
                                id="titulo"
                                formControlName="titulo"
                                placeholder="Nombre de la receta"
                            >
                        </div>

                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <input
                                type="text"
                                class="form-control"
                                id="descripcion"
                                formControlName="descripcion"
                                placeholder="Descripción breve"
                            >
                        </div>

                        <div class="mb-3">
                            <label for="instrucciones" class="form-label">Instrucciones</label>
                            <textarea
                                class="form-control"
                                id="instrucciones"
                                formControlName="instrucciones"
                                rows="6"
                                placeholder="Pasos para preparar"
                            ></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="imagenUrl" class="form-label">Imagen de la receta</label>
                            <input
                                type="file"
                                class="form-control"
                                id="imagenUrl"
                                accept="image/*"
                                (change)="onFileSelected($event)"
                                [disabled]="isUploadingImage"
                            >
                            <small class="text-muted" *ngIf="selectedImageName">
                                Seleccionado: {{ selectedImageName }}
                            </small>
                            <small class="text-muted d-block" *ngIf="isUploadingImage">
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                Subiendo imagen...
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="cancelSaveRecipe()">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-success" (click)="saveRecipeFromChat()" [disabled]="isUploadingImage">
                        Guardar receta
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="chat-input-area p-3 border-top bg-light">
        <div class="input-group">
            <input
                type="text"
                class="form-control"
                placeholder="Pregúntame por una receta... (ej: 'Dame una receta de pasta')"
                [(ngModel)]="inputMessage"
                (keyup.enter)="sendMessage()"
                [disabled]="isLoading"
            >
            <button
                class="btn btn-primary"
                type="button"
                (click)="sendMessage()"
                [disabled]="isLoading || !inputMessage.trim()"
            >
                <span *ngIf="!isLoading">Enviar</span>
                <span *ngIf="isLoading">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                </span>
            </button>
        </div>
    </div>
</main>